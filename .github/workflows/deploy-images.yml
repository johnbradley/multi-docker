name: Create and publish a Docker image

on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  getcontainers:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.value }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v19
        with:
          files: |
            **/Dockerfile
      - id: matrix
        run: |
          echo ${{ steps.changed-files.outputs.all_changed_files }}

  build-and-push-image:
    needs: getcontainers 
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        package: ${{ fromJson(needs.getcontainers.outputs.matrix) }}

    steps:
      - run: |
          echo "${{ matrix.value }}"
